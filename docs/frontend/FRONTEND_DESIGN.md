# AI-Assisted Story Writing App — Design Guide

This guide consolidates your prompts and design decisions into a clear written reference for development.

---

## Core Editor Design
- **Draft window:** Main text area composed of ordered *chunks*. Each chunk may be authored by the user or generated by the LLM.
- **Chunk semantics:**
  - Each chunk has `{id, text, author, timestamp}`.
  - Chunks are highlighted on hover.
  - Hovering reveals a menu with actions: Edit, Delete, Branch.
  - Double-click or menu → Edit opens an inline editor for that chunk.
- **Instruction box:** A smaller text field below the draft where the user writes guidance for the LLM.
- **Command bar:** Buttons for:
  - Generate continuation
  - Regenerate last chunk
  - Revert last action

---

## Sidebar Design
- **Generation settings:**
  - Temperature (slider)
  - Max tokens (number input)
- **Contextual inputs:**
  - **Synopsis** — editable textarea summarizing the story so far.
  - **Lorebook** — list of entries defining characters, places, or rules. Entries can be added and referenced during generation.

---

## Editing & History
- **Editing chunks:**
  - Inline editor opens on double-click or via hover menu.
  - Save with ⌘/Ctrl+Enter, cancel with Esc.
  - Edits are stored in the history system with action type `edit`.
- **History system:**
  - Each action (generate, regenerate, delete, edit, branch) saves a before/after snapshot.
  - Revert restores the last snapshot.

---

## Backend Integration (LLM)
- **Prompt assembly:** Include instruction, temperature, max tokens, synopsis, lorebook, and draft chunks.
- **Regeneration:** Replace the last chunk with new LLM output.
- **Branching:** Truncate the draft to a chosen chunk and optionally fork into a new draft version.

---

## Reflex.dev Implementation Notes
- **Framework fit:** Reflex enables you to stay in Python while shipping to web. Ideal for MVP speed.
- **Editor choice:** Reflex has a basic `Editor` but for chunk-aware editing:
  - Wrap **TipTap** as a custom Reflex component.
  - Use TipTap node decorations to represent chunks and attach hover menus.
- **State handling:**
  - Avoid sending every keystroke to the backend (would cause excessive WebSocket chatter).
  - Strategy: keep editing local, then sync only when a chunk is *saved* or *blurred*.
  - Reflex `State` tracks chunk list and history snapshots.
- **Streaming LLM output:** Show provisional chunk text as tokens stream in; finalize on completion.
- **Autosave:** Debounce saves to local storage or backend after stable updates.

---

## UX Considerations
- **User control:**
  - Don’t overwrite user text without explicit actions.
  - Make chunk ownership visible (User vs. LLM).
- **Collaboration (future):** If needed, plan for multi-user editing with locks or CRDT syncing.
- **Keyboard shortcuts:**
  - ⌘/Ctrl+Enter = Generate
  - ⌘/Ctrl+Shift+R = Regenerate last
  - ⌘/Ctrl+Z = Revert last
  - While editing a chunk: ⌘/Ctrl+Enter = Save, Esc = Cancel

---

## Summary
This design combines:
- A **chunk-based draft editor** with hover menus and inline editing.
- A **sidebar** for generation controls and story context.
- A **history system** for undo/redo.
- Guidance for **Reflex + TipTap integration** with considerations to avoid overloading the backend with every keystroke.

It’s structured to support quick MVP building in Python while leaving room for rich editor capabilities and scalable collaboration features later.

